<!--
--- UCSF Chimera Copyright ---
Copyright (c) 2011-2012 Regents of the University of California.
All rights reserved.  This software provided pursuant to a
license agreement containing restrictions on its disclosure,
duplication and use.  This notice must be embedded in or
attached to all copies, including partial copies, of the
software or any revisions or derivations thereof.
--- UCSF Chimera Copyright ---
-->

<html><head>
<title>fitmap</title>
</head><body>
<font size="-1">
<a href="../framecommand.html" target="_top">Chimera Commands Index</a>
</font>

<a name="top"></a>
<h3><a href="usageconventions.html">Usage</a>:
<BR><b>fitmap</b> &nbsp;<i>fit-structure</i> &nbsp;<i>ref-map</i>
&nbsp;<a href="#options"><i>options</i></a>&nbsp;
&nbsp;<a href="#global"><i>global-search-options</i></a></h3>
<p>
The command <b>fitmap</b> fits atomic coordinates into a density map or
one density map into another.  It is the command-line implementation of
<a href="../../ContributedSoftware/fitmaps/fitmaps.html"><b>Fit in Map</b></a>,
but it also has options that are not available in that tool:
<ul>
<li><a href="#global">global search</a> with random initial placement
<li><a href="#sequence">sequential fitting</a> of multiple different structures
<li><a href="#symmetric">symmetric fitting</a> of copies of the same structure
</ul>
The maps usually represent electron density, but other types of
<a href="../filetypes.html#volume">volume data</a> can also be used.
</p><p>
The <i>fit-structure</i>, either
<a href="frameatom_spec.html" target="_top">specified atoms</a> or a map model,
will be fit to <i>ref-map</i> (a map model).
Map models are specified by model number preceded by #.
If atoms are specified,
only those atoms will be used in the fitting calculation, 
but the entire model(s) containing them will be repositioned unless
<a href="#moveWholeMolecules"><b>moveWholeMolecules</b></a> is set to false.
</p><p>
Prior to
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization</a>, the fit model should be placed in a trial position 
relative to the reference map before fitting.
This usually involves <a href="../mouse.html">interactive
manipulation</a> and toggling models between
<a href="../mouse.html#activedef">active</a> and immovable states.
However, the <b>fitmap</b> command also has <a href="#global">global search
options</a> that are not available in the
<a href="../../ContributedSoftware/fitmaps/fitmaps.html"><b>Fit in Map</b></a>
graphical interface.
</p><p>
The calculation will stop and the fit structure will be repositioned after
<a href="#gridStepMin">convergence</a>
or a <a href="#maxSteps">maximum number of steps</a> (default 2000),
whichever comes first.
Reissuing the <b>fitmap</b> command may further improve results,
especially if convergence was not reached. The
<a href="../../ContributedSoftware/fitmaps/fitmaps.html"><b>Fit in Map</b></a>
graphical interface can be used to undo the fit.  After fitting,
atomic coordinates can be <a href="../savemodel.html#pdb">saved</a>
relative to the reference map.
</p><p>
Information such as the number of optimization steps, shift, and rotation
is sent to the <a href="../reply.html"><b>Reply Log</b></a>. 
If the entire fit model is repositioned, its transformation 
relative to the reference map is given as a
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#matrices">transformation
matrix</a> and as an axis of rotation (a unit vector), point on the axis,
degrees of rotation, and shift parallel to the axis.
</p><p>
See also:
<b><A href="volume.html">volume</A></b>,
<b><A href="measure.html">measure</A></b>,
<b><A href="molmap.html">molmap</A></b>,
<b><A href="sym.html">sym</A></b>,
<a href="../../ContributedSoftware/segger/fitsegments.html"><b>SegFit</b></a>,
<a href="../../ContributedSoftware/density/density.html"><b>Values at 
Atom Positions</b></a>,
<a href="../../UsersGuide/savemodel.html#afterfitting">saving maps
after fitting</a>
</p>

<a name="options">
<h4>Options</h4></a>
<p>
Option keywords for <a href="#top"><b>fitmap</b></a>
can be truncated to unique strings, and their case does not matter.  
Synonyms for true: True, 1.  Synonyms for false: False, 0.
A vertical bar &ldquo;|&rdquo; designates mutually exclusive options, and
default settings are indicated with <b>bold</b>.
</p>
<blockquote>
  <a name="resolution"><b>resolution</b> &nbsp;<i>r</i></a>
  <br>
Generate a density map from the coordinates of the specified atoms
and perform <a href="#fitmaps">map-in-map</a> fitting instead of
<a href="#fitatoms">atoms-in-map</a> fitting.  Both types of fit values
will still be reported.  The map is generated by describing each atom as a
Gaussian distribution of width proportional to <i>r</i> and
amplitude proportional to the atomic number; other map generation
parameters are set to <a href="molmap.html"><b>molmap</b></a> defaults.
If atoms are specified but this option is not given,
<a name="fitatoms"><b><i>atoms-in-map</i></b> fitting</a> will be performed:
  <blockquote>
The average map value at fit atom positions is maximized.
For each atom within the bounds of the reference map,
the map value is found by trilinear interpolation
from the eight corners of the enclosing data grid cell.
Atoms outside the bounds of the map are not used for computing averages.
  </blockquote>
</blockquote>
<blockquote>
  <a name="metric"><b>metric</b></a>
  &nbsp;<b>overlap</b>&nbsp;|&nbsp;correlation&nbsp;|&nbsp;cam 
  <br>
Which metric to use for
<a name="fitmaps"><b><i>map-in-map</i></b> fitting</a>:
 <blockquote>
The <b>overlap</b> 
(default except during <a href="#symmetric">symmetric fitting</a>) is
the sum over fit map grid points of the product of the fit
map value and the reference map value at that point,
determined by trilinear interpolation.
It can be expressed as the inner product of
vectors <b>u</b> and <b>v</b> containing the fit map values
and the corresponding interpolated reference map values:
<blockquote>
<b><i>overlap</i></b> = &lt;<b>u</b>,<b>v</b>&gt;
</blockquote>
The other possibilities are <b>correlation</b> about zero 
(default during <a href="#symmetric">symmetric fitting</a>)
and <b>cam</b> (correlation about the mean):
<blockquote>
<table cellspacing="0" cellpadding="0">
<tr><td></td><td valign="bottom">
&lt;<b>u</b>,<b>v</b>&gt;
</td></tr>
<tr><td><b><i>correlation</i></b> =&nbsp;&nbsp;</td>
<td height="1"><hr></td></tr>
<tr><td></td><td valign="top">
|&nbsp;<b>u</b>&nbsp;||&nbsp;<b>v</b>&nbsp;|
</td></tr>
</table>
</blockquote>
<blockquote>
<table cellspacing="0" cellpadding="0">
<tr><td></td><td valign="bottom">
&lt;<b>u</b>&ndash;<b>u</b><sub>ave</sub>,<b>v</b>&ndash;<b>v</b><sub>ave</sub>&gt;
</td></tr>
<tr><td><b><i>cam</i></b> =&nbsp;&nbsp;</td>
<td height="1"><hr></td></tr>
<tr><td></td><td valign="top">
|<b>u</b>&ndash;<b>u</b><sub>ave</sub>||<b>v</b>&ndash;<b>v</b><sub>ave</sub>|
</td></tr>
</table>
</blockquote>
where <b>u</b><sub>ave</sub> is a vector with all components equal to the
average of the components of <b>u</b> and <b>v</b><sub>ave</sub> is
defined analogously.
The correlation equals the cosine of the angle between the vectors
(after subtraction of averages) and can range from &ndash;1 to 1, whereas
the range of overlap values depends on the scaling of the maps.
  </blockquote>
</blockquote>
<blockquote>
  <a name="envelope"><b>envelope</b> &nbsp;<b>true</b>&nbsp;|&nbsp;false</a>
  <br>
For <a href="#fitmaps">map-in-map</a> fitting,
whether to use only the grid points in the fit map with values above 
the map's lowest contour level in
<a href="../../ContributedSoftware/volumeviewer/framevolumeviewer.html"
target="_top"><b>Volume Viewer</b></a>.  Otherwise,
all nonzero-valued fit map grid points will be included.
(Exception: for <a href="#symmetric">symmetric fitting</a>, this option
controls which reference map points, rather than fit map points, are used.)
</blockquote>

<blockquote>
<a name="shift"><b>shift</b> &nbsp;<b>true</b>&nbsp;|&nbsp;false</a>
<br>
Whether to allow translation of the fit structure during
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization</a>.
</blockquote>
<blockquote>
<a name="rotate"><b>rotate</b> &nbsp;<b>true</b>&nbsp;|&nbsp;false</a>
<br>
Whether to allow rotation of the fit structure during
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization</a>.
</blockquote>
<blockquote>
  <a name="moveWholeMolecules"><b>moveWholeMolecules</b> 
  &nbsp;<b>true</b>&nbsp;|&nbsp;false</a>
  <br>
Whether to reposition the entire model(s) containing the specified atoms.
If false, only the specified atoms will be moved.  Regardless of this setting, 
only the specified atoms will be used to calculate the fit.
This option is ignored (always <b>true</b>) when <a href="#global">global
searching</a> is performed.
</blockquote>
<blockquote>
  <b>gridStepMax</b> &nbsp;<i>max</i>
  <br>
Initial step size, default <b>0.5</b> grid unit,
where a grid unit is the spacing between reference map grid points. See
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization algorithm</a>.
</blockquote>
<blockquote>
  <a name="maxSteps"><b>maxSteps</b> &nbsp;<i>N</i></a>
  <br>
Maximum number of optimization steps per use of the <b>fitmap</b> command
(default <b>2000</b>). See
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization algorithm</a>.
</blockquote>
<blockquote>
  <a name="gridStepMin"><b>gridStepMin</b> &nbsp;<i>min</i></a>
  <br>
Criterion for <b><i>convergence</i></b>, 
when step size falls below <i>min</i> grid units (default <b>0.01</b>). See
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization algorithm</a>.
</blockquote>

<blockquote>
  <a name="eachModel"><b>eachModel</b> &nbsp;true&nbsp;|&nbsp;<b>false</b></a>
  <br>
When multiple fit models are specified, whether to fit each model 
independently of the others (cannot be combined with
<a href="#sequence">sequential fitting</a>).
The <a href="#listFits"><b>listFits</b></a> option can be used to
show the results in the <a href="#fitlist"><b>Fit List</b></a> dialog.
</blockquote>

<blockquote>
  <a name="listFits"><b>listFits</b> &nbsp;true&nbsp;|&nbsp;false</a>
  <br>
Whether to show results in the <a href="#fitlist"><b>Fit List</b></a> dialog
(default <b>true</b> when <a href="#global">global searching</a> is performed,
otherwise default <b>false</b>).
</blockquote>

<blockquote>
  <a name="sequence"><b>sequence</b> <i>M</i></a>
  <br>
When multiple fit models are specified, whether to fit each model in turn
after subtracting the density corresponding to the other models
(cannot be combined with the <a href="#eachModel"><b>eachModel</b></a> option).
Only applies to <a href="#fitmaps">map-in-map</a> fitting; if atomic models
were specified, the <a href="#resolution"><b>resolution</b></a> option
must be used to generate maps from those models.
<i>M</i> is the number of individual structure fits to perform, each time
first subtracting (temporarily) from the reference map the density 
corresponding to the other specified fit models in their current positions
(default <i>M</i> = <b>0</b>, no sequential fitting). 
Thus, the fit models should be placed in trial positions beforehand by
<a href="../mouse.html">interactive manipulation</a> and/or prior fitting runs.
If <i>M</i> is greater than the number of fit models, the calculation 
will continue to cycle through those models in the order listed.  In tests, 
good convergence was attained by cycling through all of the models five times.
Currently sequential fitting cannot be done in the same command as
<a href="#symmetric">symmetric fitting</a> or
<a href="#global">global search</a>.
See also: <a href="https://www.cgl.ucsf.edu/chimera/videodoc/FitSeq/"
target="_blank">sequential fitting video tutorial</a> (Web)
</blockquote>

<blockquote>
  <a name="symmetric"><b>symmetric</b> &nbsp;true&nbsp;|&nbsp;<b>false</b></a>
  <br>
Whether to use the symmetry of the reference map while fitting.
Only applies when the reference map has a 
<a href="volume.html#symmetry">symmetry assignment</a>, and to
<a href="#fitmaps">map-in-map</a> fitting; if atoms were specified, the 
<a href="#resolution"><b>resolution</b></a> option must be used to generate
a map from those atoms. During symmetric fitting,
the fit map and its symmetry-related virtual copies are fit into the 
reference map using the <a href="#metric"><b>metric</b></a> of
<b>correlation</b> (default) or <b>cam</b>.
Overlaps between fit map copies additively raise the fit density 
and tend to lower the correlation.
For computational efficiency, only one asymmetric unit of the reference map
is considered explicitly 
(reference map grid points closer to the center of the original fit map 
than to the centers of its copies).
The <a href="#envelope"><b>envelope</b></a> setting determines whether all
nonzero-valued reference map grid points in the asymmetric unit 
or only those above the contour level (default) are used.
Currently symmetric fitting cannot be done in the same command as
<a href="#sequence">sequential fitting</a> or
<a href="#global">global search</a>.
Whereas symmetric fitting uses virtual copies of the fit map,
symmetry-related actual copies of the corresponding atomic model
can be created with the command <a href="sym.html"><b>sym</b></a>.
See also: 
<a href="https://www.cgl.ucsf.edu/chimera/videodoc/SymFitDNAb/"
target="_blank">symmetric fitting video tutorial</a> (Web)
</blockquote>

<table cellspacing="0" cellpadding="0"
align="right" style="margin:8px 8px 8px 8px"> 
<tr><td align="center">
Click for
<a href="https://www.cgl.ucsf.edu/chimera/videodoc/FitSearch/"
target="_blank">video tutorial</a>
on <a href="#top"><b>fitmap</b></a> global search (Web)...
</td></tr><tr><td>
<a href="https://www.cgl.ucsf.edu/chimera/videodoc/FitSearch/" target="_blank">
<img src="globalfit.png" title="click for video tutorial (Web)..."></a>
</td></tr>
</table>

<a name="global">
<h4>Global Search Options</h4></a>
<p>
A <a href="#search"><b>search</b></a> value <i>N</i> &gt; 0 indicates
some degree of global searching with the <a href="#top"><b>fitmap</b></a>
command.  In global search, <i>N</i> initial placements of the fit model 
within the reference map are generated randomly, then subjected to
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization</a>.  The whole model will be moved regardless of the
<a href="#moveWholeMolecules"><b>moveWholeMolecules</b></a> setting.
The resulting unique fits are listed in a separate dialog, 
the <a href="#fitlist"><b>Fit List</b></a>,
where uniqueness depends on <a href="#clusterAngle">rotational differences</a>,
<a href="#clusterShift">translational differences</a>,
and lack of <a href="#asymmetricUnit">equivalence by symmetry</a>.
In addition, the user can require <a href="#inside">some fraction</a>
of the fit atoms or fit map grid points to be inside the reference map 
contour surface for the fit to be retained.
Only the first fit in a uniqueness cluster is listed, along with the
number of cluster members (hits).
</p>
<blockquote>
  <a name="search"><b>search</b> &nbsp;<i>N</i></a>
  <br>
Number of initial placements (prior to 
<a href="../../ContributedSoftware/fitmaps/fitmaps.html#optimization">local
optimization</a>)
of the fit model within the reference map (default <b>0</b>, no global search).
The <a href="#placement"><b>placement</b></a> option can be used to constrain
initial placements to only rotations or shifts from the current position.
</blockquote>
<blockquote>
  <a name="placement"><b>placement</b> 
  &nbsp;s&nbsp;|&nbsp;r&nbsp;|&nbsp;<b>sr</b></a>
  <br>
In global search, how to generate initial placements of the fit model:
<ul>
<li><b>s</b> - random shifts (translations) starting from the current position,
keeping the geometric center of the fit atoms or fit map grid points
within the bounding box of the displayed part of the reference map.
The search radius can be restricted further with the
<a href="#radius"><b>radius</b></a> option.
The <a href="#envelope"><b>envelope</b></a> setting determines whether all
nonzero-valued fit map grid points or only those above the contour level 
(default) are used to calculate the center.
<li><b>r</b> - random rotations starting from the current position
<li><b>sr</b> (default) - both shifts and rotations
</ul>
This option does not affect what movements are allowed during 
local optimization, which are instead set by
<a href="#shift"><b>shift</b></a> and <a href="#rotate"><b>rotate</b></a>.
</blockquote>
<blockquote>
  <a name="radius"><b>radius</b> &nbsp;<i>maxdist</i></a>
  <br>
Limit the global search to initial placements within <i>maxdist</i> 
of the current position.
</blockquote>
<blockquote>
  <a name="clusterAngle"><b>clusterAngle</b> &nbsp;<i>angle</i></a>
  <br>
The <i>angle</i> (default <b>6</b>&deg;) is the rotational difference
required for a fit to be considered unique.  Only unique fits are included
in the list of results.
</blockquote>
<blockquote>
  <a name="clusterShift"><b>clusterShift</b> &nbsp;<i>shift</i></a>
  <br>
The <i>shift</i> (default <b>3</b> &Aring;) is the translational difference
required for a fit to be considered unique.  Only unique fits are included
in the list of results.
</blockquote>
<blockquote>
  <a name="asymmetricUnit"><b>asymmetricUnit</b> &nbsp;<b>true</b>&nbsp;|&nbsp;false</a>
  <br>
If the reference map has symmetry information (such as from
<a href="measure.html#symmetry"><b>measure symmetry</b></a>), 
whether to list only the fits from one asymmetric unit.
In other words, whether to exclude symmetry-equivalent fits 
from being considered unique. Of a symmetry-equivalent set of fits,
the one that places the fit structure geometric center closest to
volume box fractional coordinates (0.75,0.55,0.55) in the reference map 
is included in the list of results.
</blockquote>
<blockquote>
  <a name="inside"><b>inside</b> &nbsp;<i>fraction</i></a>
  <br>
The <i>fraction</i> is what proportion of fit atoms or fit map grid points
must lie inside the reference map contour surface for the fit to be retained
(default <b>0.1</b>).
The <a href="#envelope"><b>envelope</b></a> setting determines whether all 
nonzero-valued fit map grid points or only those above the contour level 
(default) are considered.
</blockquote>

<a name="fitlist">
<h4>Fit List</h4></a>
<p>
Unique fits from running the <a href="#top"><b>fitmap</b></a> command with 
<a href="#global">global search</a> are enumerated in a <b>Fit List</b> dialog.
The <a href="#listFits"><b>listFits</b></a> option can be used to show 
the results of other <a href="#top"><b>fitmap</b></a> runs as well
(for example, fitting multiple models independently with the
<a href="#eachModel"><b>eachModel</b></a> option).
</p><p>
<a name="choosefit">
Clicking a row <b><i>chooses</i></b> the corresponding fit</a>
and moves the fit model to regenerate it. 
The <b>Fit List</b> is included in saved 
<a href="../../UsersGuide/sessions.html">sessions</a>.  
Columns:
<ul>
<li><b>Corr</b>
- <a href="#fitmaps">map-in-map</a> fitting metric: correlation about zero
<li><b>Ave</b>
- <a href="#fitatoms">atoms-in-map</a> fitting metric:
average map value at fit atom positions
<li><b>Inside</b>
- what proportion of fit atoms 
(<a href="#fitatoms">atoms-in-map</a> fitting)
or fit map grid points
(<a href="#fitmaps">map-in-map</a> fitting)
are inside the reference map contour surface.
The <a href="#envelope"><b>envelope</b></a> setting determines whether all 
nonzero-valued fit map grid points or only those above the contour level 
(default) are considered.
<li><b>Clash</b> 
- overlap of the fit model contour surface with its symmetry-related copies,
see <a href="#fitlist-options"><b>Fit List</b> options</a>
(applies only to <a href="#fitmaps">map-in-map</a> fitting 
when the reference map has symmetry information)
<li><b>Molecule</b> - fit model
<li><b>Map</b> - reference model
<li><b>Hits</b> - number of fits in the uniqueness cluster
</ul>
Clicking <a name="fitlist-options"><b>Options</b></a> 
reveals additional settings (clicking the close button 
<img src ="../../ContributedSoftware/volumeviewer/x.png"> on the right
hides them again):
<ul>
<li><b>Smooth motion between fits [&nbsp;M&nbsp;] steps</b>
- number of frames over which to move the fit model from its current position
to the fit position when a row is clicked
<li><b>Show clash volume fraction between symmetric copies</b>
- whether to show a column of <b>Clash</b> values, the amount of overlap
between the fit model contour surface and its symmetry-related
copies (applies only to <a href="#fitmaps">map-in-map</a> fitting 
when the reference map has symmetry information).  The values depend on the 
fit map contour level. The clash fraction equals the number of grid points 
from symmetry-related copies that fall inside the original copy,
divided by the total number of grid points within the original.
</ul>
Other buttons:
<ul>
<li><b>Place Copy</b> - if atoms were specified as the fit structure,
open a copy for each <a href="#choosefit">chosen fit</a> as a new model
<li><b>Save PDB</b> - if atoms were specified as the fit structure, 
save each <a href="#choosefit">chosen fit</a> as a PDB file
<li><b>Delete</b> 
- remove each <a href="#choosefit">chosen fit</a> from the list
<li><b>Clear List</b> - remove all fits
<li><b>Close</b> - dismiss the <b>Fit List</b>
<li><b>Help</b> - show documentation in a browser window
</ul>
</p>

</body></html>
